<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="author" content="Jeremias Yehdegho">
<meta name="description" content="When writing safety-critical software, people often use languages like Ada, C or C&#43;&#43;. The former has an excellent reputation concerning safety, the latter two absolutely do not. In order to make the use of C and C&#43;&#43; safer, people write in restricted subsets of these languages, avoiding dangerous language constructs and features.
One of such language subset is the Autosar coding guidelines for C&#43;&#43;14, which are based on earlier coding standards, such as MISRA and the JSF coding standard.">

<meta property="og:title" content="Writing a Checker for Clang" />
<meta property="og:description" content="When writing safety-critical software, people often use languages like Ada, C or C&#43;&#43;. The former has an excellent reputation concerning safety, the latter two absolutely do not. In order to make the use of C and C&#43;&#43; safer, people write in restricted subsets of these languages, avoiding dangerous language constructs and features.
One of such language subset is the Autosar coding guidelines for C&#43;&#43;14, which are based on earlier coding standards, such as MISRA and the JSF coding standard." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://qcoh.github.io/blog/writing-a-checker-for-clang/" />
<meta property="article:published_time" content="2019-05-11T15:01:47&#43;02:00"/>
<meta property="article:modified_time" content="2019-05-11T15:01:47&#43;02:00"/>


<title>


     Writing a Checker for Clang 

</title>
<link rel="canonical" href="https://qcoh.github.io/blog/writing-a-checker-for-clang/">










<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500">



    <link rel="stylesheet" href="https://qcoh.github.io/css/reset.css">
    <link rel="stylesheet" href="https://qcoh.github.io/css/pygments.css">
    <link rel="stylesheet" href="https://qcoh.github.io/css/main.css">
    




<link rel="shortcut icon"

    href="https://qcoh.github.io/img/favicon.ico"

>








</head>


<body lang="">

<section class="header">
    <div class="container">
        <div class="content">
            
                
                
                
                
                
                    
                
                
                <a href="https://qcoh.github.io/"><img class="avatar" src="//profile.jpg" srcset="https://qcoh.github.io/profile.jpg 1x"></a>
            
            <a href="https://qcoh.github.io/"><div class="name">Jeremias Yehdegho</div></a>
            
            <nav>
                <ul>
                    
                        <li class="nav-blog"><a href="https://qcoh.github.io/posts/"><span>Blog</span></a></li>
                    
                        <li class="nav-about"><a href="https://qcoh.github.io/about/"><span>About</span></a></li>
                    
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">
        
            <a href="//github.com/qcoh" target="_blank" rel="noopener"><img class="icon" src="https://qcoh.github.io/img/github.svg" alt="github" /></a>
        

        

        
            <a href="//twitter.com/quasicoherent" target="_blank" rel="noopener"><img class="icon" src="https://qcoh.github.io/img/twitter.svg" alt="twitter" /></a>
        

	

        

        

        
            <a href="//linkedin.com/in/jeremias-yehdegho" target="_blank" rel="noopener"><img class="icon" src="https://qcoh.github.io/img/linkedin.svg" alt="linkedin" /></a>
        

        

        

        

        

        

        
            <a href="mailto:quasicoherent@protonmail.com"><img class="icon" src="https://qcoh.github.io/img/email.svg" alt="email" /></a>
        

        

        
        </div>
    </div>
</section>

<section class="main">
    <div class="container">
        <div class="content">
            <div class="page-heading">

    Writing a Checker for Clang

</div>

            <div class="markdown">
                

<p>When writing safety-critical software, people often use languages
like Ada, C or C++. The former has an excellent reputation concerning
safety, the latter two absolutely do not. In order to make the use
of C and C++ safer, people write in restricted subsets of these languages,
avoiding dangerous language constructs and features.</p>

<p>One of such language subset is the <a href="https://www.autosar.org/fileadmin/user_upload/standards/adaptive/17-03/AUTOSAR_RS_CPP14Guidelines.pdf">Autosar coding guidelines for C++14</a>,
which are based on earlier coding standards, such as MISRA and the JSF coding standard.</p>

<p>In this post, I want to explain how to write a checker for the following
Autosar rule using clang:</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">Rule A3-2-2 (required, implementation, automated)  
Non-POD type objects with static storage duration shall not be used.</pre></div>
<p>You can find the code <a href="https://github.com/qcoh/SimpleChecker">here</a>.</p>

<h2 id="project-setup-on-ubuntu-18-04-with-cmake">Project Setup on Ubuntu 18.04 with CMake</h2>

<p>The recommended approach according to clang website is to build llvm and clang
yourself. However compiling LLVM and clang takes a lot of time and space and I gave
up on that on my underpowered laptop after several hours and tens of gigabytes.</p>

<p>Fortunately, you can use the development libraries on Ubuntu (and presumably other Linux
distributions as well). For Ubuntu 18.04, you can install the dependencies via:</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">sudo apt install llvm-7idev libclang-7-dev clang-tools-7</pre></div>
<p>My project setup is</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">.
├── CMakeLists.txt
├── example
│   └── example.cpp
└── SimpleChecker.cpp</pre></div>
<p>with CMakeLists.txt as follows:</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-CMake" data-lang="CMake"><span style="color:#008000">cmake_minimum_required</span>(<span style="color:#ba2121">VERSION</span> <span style="color:#ba2121">3.10</span>)<span style="">
</span><span style=""></span><span style="color:#008000">project</span>(<span style="color:#ba2121">simple_checker</span> <span style="color:#ba2121">LANGUAGES</span> <span style="color:#ba2121">CXX</span>)<span style="">
</span><span style="">
</span><span style=""></span><span style="color:#008000">set</span>(<span style="color:#ba2121">CMAKE_CXX_STANDARD</span> <span style="color:#ba2121">17</span>)<span style="">
</span><span style=""></span><span style="color:#008000">set</span>(<span style="color:#ba2121">CMAKE_CXX_STANDARD_REQUIRED</span> <span style="color:#ba2121">YES</span>)<span style="">
</span><span style=""></span><span style="color:#008000">set</span>(<span style="color:#ba2121">CMAKE_CXX_EXTENSIONS</span> <span style="color:#ba2121">NO</span>)<span style="">
</span><span style="">
</span><span style=""></span><span style="color:#008000">find_package</span>(<span style="color:#ba2121">LLVM</span> <span style="color:#ba2121">REQUIRED</span> <span style="color:#ba2121">CONFIG</span>)<span style="">
</span><span style=""></span><span style="color:#008000">include_directories</span>(<span style="color:#666">${</span><span style="color:#19177c">LLVM_INCLUDE_DIRS</span><span style="color:#666">}</span>)<span style="">
</span><span style="">
</span><span style=""></span><span style="color:#008000">add_library</span>(<span style="color:#ba2121">simple_checker</span> <span style="color:#ba2121">SHARED</span>
	<span style="color:#ba2121">SimpleChecker.cpp</span>
)<span style="">
</span><span style="">
</span><span style=""></span><span style="color:#008000">target_link_libraries</span>(<span style="color:#ba2121">simple_checker</span> <span style="color:#ba2121">PRIVATE</span>
	<span style="color:#ba2121">LLVM</span>
)</code></pre></div>
<h2 id="a-simple-checker-autosar-rule-a3-2-2">A simple Checker &ndash; Autosar Rule A3-2-2</h2>

<p>clang&rsquo;s checkers are visitors over e.g. variable declarations,
enum statements, return statements, etc. These visitors are implemented by deriving
from a template base class:</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-CPP" data-lang="CPP"><span style="color:#008000;font-weight:bold">class</span><span style=""> </span><span style="color:#00f;font-weight:bold">SimpleChecker</span> <span style="color:#666">:</span> <span style="color:#008000;font-weight:bold">public</span> Checker<span style="color:#666">&lt;</span>check<span style="color:#666">::</span>ASTDecl<span style="color:#666">&lt;</span>VarDecl<span style="color:#666">&gt;&gt;</span>
</code></pre></div>
<p>The template parameters list the language constructs you want to visit. In our case,
we only need to check the variable declarations, hence <code>ASTDecl&lt;VarDecl&gt;</code>. As this
indirection suggests, there are several
other declarations, such as <code>FunctionDecl</code> (for function declarations), <code>RecordDecl</code>
(for record declarations, i.e. class members) and so on.</p>

<p>The actual check is implement as a method:</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-CPP" data-lang="CPP"><span style="color:#b00040">void</span> <span style="color:#00f">checkASTDecl</span>(<span style="color:#008000;font-weight:bold">const</span> VarDecl <span style="color:#666">*</span>varDecl, AnalysisManager <span style="color:#666">&amp;</span>analysisManager, BugReporter <span style="color:#666">&amp;</span>bugReporter) <span style="color:#008000;font-weight:bold">const</span> {
	<span style="color:#008000;font-weight:bold">if</span> (<span style="color:#666">!</span>varDecl) {
		<span style="color:#008000;font-weight:bold">return</span>;
	}

	<span style="color:#008000;font-weight:bold">const</span> <span style="color:#b00040">bool</span> hasStaticStorageDuration <span style="color:#666">=</span> 
		varDecl<span style="color:#666">-&gt;</span>isStaticLocal() <span style="color:#666">||</span>
		varDecl<span style="color:#666">-&gt;</span>isStaticDataMember() <span style="color:#666">||</span>
		varDecl<span style="color:#666">-&gt;</span>hasGlobalStorage();

	<span style="color:#008000;font-weight:bold">const</span> <span style="color:#b00040">bool</span> isPOD <span style="color:#666">=</span> varDecl<span style="color:#666">-&gt;</span>getType().isPODType(varDecl<span style="color:#666">-&gt;</span>getASTContext());

	<span style="color:#008000;font-weight:bold">if</span> (hasStaticStorageDuration <span style="color:#666">&amp;&amp;</span> <span style="color:#666">!</span>isPOD) {
		PathDiagnosticLocation pathDiagnosticLocation <span style="color:#666">=</span>
		    PathDiagnosticLocation<span style="color:#666">::</span>create(varDecl, bugReporter.getSourceManager());

		bugReporter.emitReport(
		    std<span style="color:#666">::</span>make_unique<span style="color:#666">&lt;</span>BugReport<span style="color:#666">&gt;</span>(
			<span style="color:#666">*</span>m_bugType,
			m_bugType<span style="color:#666">-&gt;</span>getName(),
			pathDiagnosticLocation));
	}
}
</code></pre></div>
<p>Static storage duration of a variable can mean one of three things:</p>

<ul>
<li>It is a local variable, which we check using <code>isStaticLocal</code></li>
<li>It is a static member variable of a class, which we check using <code>isStaticDataMember</code></li>
<li>It is a global variable, either static or inside an anonymous namespace, which we check using <code>hasGlobalStorage</code></li>
</ul>

<p>To check whether the type of the variable is a plain old data type, we first obtain
the underlying type of the declaration and then invoke the method <code>isPODType</code>, which
tells us just that.</p>

<p>If we find that a non-POD variable has static storage duration, we report an error.
Notice how we pass information on the location of the issue, resulting in the
nice error messages with line numbers and code snippets, for which clang is known for.</p>

<p>Lastly, we register the checker:</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-CPP" data-lang="CPP"><span style="color:#008000;font-weight:bold">extern</span> <span style="color:#ba2121">&#34;C&#34;</span> <span style="color:#b00040">void</span> clang_registerCheckers(CheckerRegistry <span style="color:#666">&amp;</span>registry) {
	registry.addChecker<span style="color:#666">&lt;</span>SimpleChecker<span style="color:#666">&gt;</span>(
		<span style="color:#ba2121">&#34;autosar.A3-3-2&#34;</span>,
		<span style="color:#ba2121">&#34;Non-POD type objects with static storage duration shall not be used.&#34;</span>);
}

<span style="color:#008000;font-weight:bold">extern</span> <span style="color:#ba2121">&#34;C&#34;</span> <span style="color:#008000;font-weight:bold">const</span> <span style="color:#b00040">char</span> clang_analyzerAPIVersionString[] <span style="color:#666">=</span> CLANG_ANALYZER_API_VERSION_STRING;
</code></pre></div>
<h2 id="building-and-using-the-checker">Building and Using the Checker</h2>

<p>We can build the checker by creating a build directory, running CMake and make from there:</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">mkdir build &amp;&amp; cd build
cmake .. &amp;&amp; make</pre></div>
<p>The result will be the shared library <code>libsimple_checker.so</code>, which can be used
from clang&rsquo;s <code>scan-build-7</code> script. Essentially this script sets the <code>CXX</code> environment
variable to an instrumented clang, which uses the configured checkers. The arguments
to this script can be a direct invocation of a compiler or build system.</p>

<p>To make sure everything works, check whether the just written checker is among
the available checkers:</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">scan-build-7 -load-plugin ./libsimple_checker.so --help</pre></div>
<p>Output:</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">[...]
   autosar.A3-3-2                  Non-POD type objects with static storage duration shall not be used.
[...]</pre></div>
<p>In order to see whether the checker works, I copied<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup> the example from the Autosar coding
guidelines, which contains the following code:</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-CPP" data-lang="CPP"><span style="color:#008000;font-weight:bold">class</span><span style=""> </span><span style="color:#00f;font-weight:bold">A</span> {
<span style="color:#008000;font-weight:bold">public</span><span style="color:#666">:</span>
	A() <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">default</span>;
	A(<span style="color:#008000;font-weight:bold">const</span> A <span style="color:#666">&amp;</span>) {}
	<span style="color:#008000;font-weight:bold">static</span> std<span style="color:#666">::</span>uint8_t instanceId;
	<span style="color:#008000;font-weight:bold">static</span> <span style="color:#b00040">float</span> <span style="color:#008000;font-weight:bold">const</span> pi;
	<span style="color:#008000;font-weight:bold">static</span> std<span style="color:#666">::</span>string <span style="color:#008000;font-weight:bold">const</span> seperator;
};

<span style="color:#008000;font-weight:bold">static_assert</span>(<span style="color:#666">!</span>std<span style="color:#666">::</span>is_pod<span style="color:#666">&lt;</span>A<span style="color:#666">&gt;::</span>value);

std<span style="color:#666">::</span>uint8_t A<span style="color:#666">::</span>instanceId <span style="color:#666">=</span> <span style="color:#666">0</span>;
<span style="color:#b00040">float</span> <span style="color:#008000;font-weight:bold">const</span> A<span style="color:#666">::</span>pi <span style="color:#666">=</span> <span style="color:#666">3.14</span>;
std<span style="color:#666">::</span>string <span style="color:#008000;font-weight:bold">const</span> A<span style="color:#666">::</span>seperator <span style="color:#666">=</span> <span style="color:#ba2121">&#34;===&#34;</span>;
</code></pre></div>
<p>Since <code>std::string</code> is not a POD type, we expect a warning here, which we can indeed
see if we enable and run the checker with:</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">scan-build-7 -load-plugin ./libsimple_checker.so -enable-checker autosar.A3-3-2 clang++-7 -std=c++17 ../example/example.cpp -c -o foo</pre></div>
<p>Output:</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">[...]
../example/example.cpp:14:27: warning: Non-POD type objects with static storage duration shall not be used
        static std::string const seperator;
                                 ^~~~~~~~~
../example/example.cpp:21:22: warning: Non-POD type objects with static storage duration shall not be used
std::string const A::seperator = &#34;===&#34;;
                     ^~~~~~~~~
[...]</pre></div>
<h2 id="summary">Summary</h2>

<p>In this post, we implemented a simple checker using clang&rsquo;s static analysis
infrastructure. In the process, we saw some of the basic classes of clang and how
they make the information needed for this checker (somewhat) easily available. Lastly,
we used the checker on the example given by the coding guidelines and saw the warnings
we expected.</p>

<p>You can find the full code <a href="https://github.com/qcoh/SimpleChecker">here</a>.</p>

<h2 id="further-material">Further Material</h2>

<p>If you want to dig deeper, I found the following very helpful:</p>

<ul>
<li><a href="https://www.youtube.com/watch?v=kdxlsP5QVPw">How to Write a Checker in 24 Hours</a> (<a href="https://llvm.org/devmtg/2012-11/Zaks-Rose-Checker24Hours.pdf">Slides</a>)</li>
<li><a href="https://www.youtube.com/watch?v=VqCkCDFLSsc">The Clang AST - a Tutorial</a></li>
<li><a href="https://github.com/llvm/llvm-project/blob/master/clang/lib/StaticAnalyzer/Checkers/CheckerDocumentation.cpp">CheckerDocumentation.cpp</a></li>
</ul>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">The example from the guidelines does not seem to be correct. I had to add a copy constructor to make it non-POD.
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>

            </div>
        </div>
    </div>
</section>








</body>
</html>

